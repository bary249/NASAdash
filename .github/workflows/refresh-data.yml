name: Refresh RealPage Data

on:
  schedule:
    # Run every 6 hours (UTC): 00:00, 06:00, 12:00, 18:00
    - cron: '0 */6 * * *'
  workflow_dispatch: # Manual trigger from GitHub UI

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install playwright
          playwright install chromium

      - name: Refresh RealPage token
        env:
          REALPAGE_EMAIL: ${{ secrets.REALPAGE_EMAIL }}
          REALPAGE_PASSWORD: ${{ secrets.REALPAGE_PASSWORD }}
        run: python auto_token.py --force

      - name: Check token
        run: python auto_token.py --check

      - name: Run full data pipeline
        env:
          REALPAGE_EMAIL: ${{ secrets.REALPAGE_EMAIL }}
          REALPAGE_PASSWORD: ${{ secrets.REALPAGE_PASSWORD }}
          ZEMBRA_API_KEY: ${{ secrets.ZEMBRA_API_KEY }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: python refresh_all.py

      - name: Validate data before push
        run: python validate_data.py

      - name: Push DBs to Railway
        env:
          RAILWAY_API_URL: ${{ secrets.RAILWAY_API_URL }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: python push_to_deployed.py

      - name: Post-push smoke test
        env:
          RAILWAY_API_URL: ${{ secrets.RAILWAY_API_URL }}
        run: |
          echo "Waiting 10s for Railway to reload DBs..."
          sleep 10
          BACKEND="${RAILWAY_API_URL:-https://brilliant-upliftment-production-3a4d.up.railway.app}"
          echo "Testing $BACKEND..."
          # Health check
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND/api/v2/health")
          echo "  /api/v2/health: $STATUS"
          [ "$STATUS" = "200" ] || { echo "❌ Health check failed"; exit 1; }
          # Parkside marketing (200=data, 404=no data yet — both OK, 5xx=broken)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND/api/v2/properties/parkside/marketing?timeframe=mtd")
          echo "  /parkside/marketing: $STATUS"
          [ "$STATUS" -lt 500 ] 2>/dev/null || { echo "❌ Marketing endpoint error ($STATUS)"; exit 1; }
          # Parkside move-out reasons (200=data, 404=no data yet — both OK)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND/api/v2/properties/parkside/move-out-reasons")
          echo "  /parkside/move-out-reasons: $STATUS"
          [ "$STATUS" -lt 500 ] 2>/dev/null || { echo "❌ Move-out reasons endpoint error ($STATUS)"; exit 1; }
          # Parkside occupancy
          BODY=$(curl -s "$BACKEND/api/v2/properties/parkside/availability")
          UNITS=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('total_units',0))")
          echo "  /parkside/availability: total_units=$UNITS"
          [ "$UNITS" -gt 0 ] 2>/dev/null || { echo "❌ Availability returned 0 units"; exit 1; }
          echo "✅ All post-push checks passed"
